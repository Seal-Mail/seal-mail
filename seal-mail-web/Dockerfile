FROM skiff-core:latest as skemail_base

WORKDIR /usr/src/app
# Install all libs
COPY --from=skiff-libs:latest /usr/src/app/libs libs

# Install skemail-web dependencies
WORKDIR /usr/src/app/apps/skemail-web
COPY . .
CMD [ "yarn", "build"]

FROM skemail_base AS skemail
WORKDIR /usr/src/app/apps/skemail-web
CMD [ "yarn", "build"]

FROM skemail_base AS cdn_build
ARG NEXT_PUBLIC_GIT_HASH
ARG NEXT_PUBLIC_API_BASE_URL
ARG NEXT_PUBLIC_HCAPTCHA_SITE_KEY
ARG NEXT_PUBLIC_PASSIVE_HCAPTCHA_SITE_KEY
ARG NEXT_PUBLIC_LD_CLIENT_SIDE_ID
ARG NEXT_PUBLIC_DD_RUM_ENABLED="false"
ARG NEXT_PUBLIC_DD_FORWARD_ERROR_MESSAGES=""
ARG NEXT_PUBLIC_DD_RUM_SAMPLE_RATE=""
ARG NEXT_PUBLIC_DD_RUM_PREMIUM_SAMPLE_RATE=""
ARG NEXT_PUBLIC_DD_RUM_SERVICE_NAME=""
ARG NEXT_PUBLIC_DD_RUM_ENV=""
ARG NEXT_PUBLIC_DD_RUM_SITE=""
ARG NEXT_PUBLIC_DD_RUM_APP_ID=""
ARG NEXT_PUBLIC_DD_RUM_CLIENT_TOKEN=""
ARG NEXT_PUBLIC_HCAPTCHA_SITE_KEY=""
ARG NEXT_PUBLIC_PASSIVE_HCAPTCHA_SITE_KEY=""

ENV NEXT_PUBLIC_GIT_HASH=$NEXT_PUBLIC_GIT_HASH
ENV NEXT_PUBLIC_API_BASE_URL=$NEXT_PUBLIC_API_BASE_URL
ENV NEXT_PUBLIC_HCAPTCHA_SITE_KEY=$NEXT_PUBLIC_HCAPTCHA_SITE_KEY
ENV NEXT_PUBLIC_PASSIVE_HCAPTCHA_SITE_KEY=$NEXT_PUBLIC_PASSIVE_HCAPTCHA_SITE_KEY
ENV NEXT_PUBLIC_LD_CLIENT_SIDE_ID=$NEXT_PUBLIC_LD_CLIENT_SIDE_ID

WORKDIR /usr/src/app/apps/skemail-web
RUN yarn export

FROM scratch as artifact
# Exports static bundle
COPY --from=cdn_build /usr/src/app/apps/skemail-web/out dist/

FROM skemail AS production_build
WORKDIR /usr/src/app/apps/skemail-web

ARG NEXT_PUBLIC_GIT_HASH
ARG NEXT_PUBLIC_API_BASE_URL
ARG NEXT_PUBLIC_HCAPTCHA_SITE_KEY
ARG NEXT_PUBLIC_PASSIVE_HCAPTCHA_SITE_KEY
ARG NEXT_PUBLIC_LD_CLIENT_SIDE_ID
ARG NEXT_PUBLIC_DD_RUM_ENABLED="false"
ARG NEXT_PUBLIC_DD_FORWARD_ERROR_MESSAGES=""
ARG NEXT_PUBLIC_DD_RUM_SAMPLE_RATE=""
ARG NEXT_PUBLIC_DD_RUM_PREMIUM_SAMPLE_RATE=""
ARG NEXT_PUBLIC_DD_RUM_SERVICE_NAME=""
ARG NEXT_PUBLIC_DD_RUM_ENV=""
ARG NEXT_PUBLIC_DD_RUM_SITE=""
ARG NEXT_PUBLIC_DD_RUM_APP_ID=""
ARG NEXT_PUBLIC_DD_RUM_CLIENT_TOKEN=""
ARG NEXT_PUBLIC_HCAPTCHA_SITE_KEY=""
ARG NEXT_PUBLIC_PASSIVE_HCAPTCHA_SITE_KEY=""

ENV NEXT_PUBLIC_GIT_HASH=$NEXT_PUBLIC_GIT_HASH
ENV NEXT_PUBLIC_API_BASE_URL=$NEXT_PUBLIC_API_BASE_URL
ENV NEXT_PUBLIC_HCAPTCHA_SITE_KEY=$NEXT_PUBLIC_HCAPTCHA_SITE_KEY
ENV NEXT_PUBLIC_PASSIVE_HCAPTCHA_SITE_KEY=$NEXT_PUBLIC_PASSIVE_HCAPTCHA_SITE_KEY
ENV NEXT_PUBLIC_LD_CLIENT_SIDE_ID=$NEXT_PUBLIC_LD_CLIENT_SIDE_ID
# DD_... vars are only used on the static site, so we only need them during yarn build,
# not yarn start -> no need to ENV them.

RUN yarn build
CMD ["yarn", "start", "--port=8080", "--hostname=0.0.0.0"]
